#pragma once

#include <stdint.h>

#define PAGE_SIZE (0x1000)
#define NUM_MSQIDS (0x100)
#define MSG_TEXT_SIZE(x) (         \
    (x) - sizeof(struct msg_msg) - \
    sizeof(struct msg_msgseg) * (((x + PAGE_SIZE - 1) / PAGE_SIZE) - 1))

struct list_head {
    uint64_t next;
    uint64_t prev;
};

struct msg_msg {
    struct list_head m_list;
    uint64_t m_type;
    uint64_t m_ts;
    uint64_t next;
    uint64_t security;
    char mtext[0];
};

struct msg_msgseg {
    uint64_t next;
    char mtext[0];
};

struct typ_msg {
    long mtype;
    char mtext[0];
};

extern int msqid[NUM_MSQIDS];

void init_msq();
void clear_msq(struct typ_msg *msgp, size_t msgsz, long mtype);