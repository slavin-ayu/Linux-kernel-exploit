#define _GNU_SOURCE
#include <stdio.h>
#include <ifaddrs.h>
#include <net/if.h>
#include <sys/ioctl.h>
#include <string.h>
#include <limits.h>
#include <sched.h>
#include <unistd.h>

#include "common.h"
#include "log.h"
#include "env.h"
#include "nf_tables.h"

void bring_interface_up(const char *ifname)
{
    int sockfd;
    struct ifreq ifr;

    sockfd = socket(AF_INET, SOCK_DGRAM, 0);
    if (sockfd < 0)
        die("socket");

    memset(&ifr, 0, sizeof(ifr));
    strncpy(ifr.ifr_name, ifname, IFNAMSIZ);
    ifr.ifr_flags |= IFF_UP;
    ioctl(sockfd, SIOCSIFFLAGS, &ifr);

    close(sockfd);
}

void disable_rpf_by_ifname(const char *ifname)
{
    char rp_filter_path[PATH_MAX];

    logd("disabling rpf for interface: '%s'", ifname);

    sprintf(rp_filter_path, "/proc/sys/net/ipv4/conf/%s/rp_filter", ifname);

    write_file(rp_filter_path, "0\n", 2, 0);
}

void disable_rpf_for_all()
{
    struct ifaddrs *addrs;

    getifaddrs(&addrs);

    for (struct ifaddrs *curr = addrs; curr != NULL; curr = curr->ifa_next)
        if (curr->ifa_addr && curr->ifa_addr->sa_family == AF_PACKET)
            disable_rpf_by_ifname(curr->ifa_name);

    freeifaddrs(addrs);
}

void configure_net_interfaces() {
    bring_interface_up("lo");

    logd("disabling RPF in network namespace...");
    disable_rpf_for_all();
    write_file("/proc/sys/net/ipv4/conf/all/rp_filter", "0\n", 2, 0);
}

void configure_uid_map(uid_t old_uid, gid_t old_gid) {
    char uid_map[128];
    char gid_map[128];

    logd("setting up UID namespace...");
    
    sprintf(uid_map, "0 %d 1\n", old_uid); 
    sprintf(gid_map, "0 %d 1\n", old_gid);

    // write the uid/gid mappings. setgroups = "deny" to prevent permission error 
    logd("mapping uid %d to namespace uid 0...", old_uid);
    write_file("/proc/self/uid_map", uid_map, strlen(uid_map), 0);

    logd("denying namespace rights to set user groups...");
    write_file("/proc/self/setgroups", "deny", strlen("deny"), 0);

    logd("mapping gid %d to namespace gid 0...", old_gid);
	write_file("/proc/self/gid_map", gid_map, strlen(gid_map), 0);
}

void do_unshare() {
    logd("creating new user namespace...");
    if(unshare(CLONE_NEWUSER) < 0)
        die("unshare(CLONE_NEWUSER)");

    logd("creating new network namespace..."); 
    if (unshare(CLONE_NEWNET) < 0)
        die("unshare(CLONE_NEWNET)");
}

void setup_env() {
    uid_t uid = getuid();
    gid_t gid = getgid();

    logi("Setting up environment");
    do_unshare();
    configure_uid_map(uid, gid);
    configure_net_interfaces();
    configure_nftables();
}