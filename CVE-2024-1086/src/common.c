#define _GNU_SOURCE
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <sched.h>
#include <stdint.h>
#include <fcntl.h>
#include <string.h>

#include "common.h"
#include "log.h"

void bind_core(int core){
    cpu_set_t cpu_set;

    CPU_ZERO(&cpu_set);
    CPU_SET(core, &cpu_set);

    if (sched_setaffinity(0, sizeof(cpu_set_t), &cpu_set) == -1)
        die("sched_setaffinity");

    logd("Process binded to core %d", core);
}

// micro function (don't print "doing X..." status)
// removes error checking boilerplate
void write_file(const char *filename, const char *buf, size_t buflen, unsigned int flags)
{
    int fd;

    fd = open(filename, O_WRONLY | O_CREAT | flags, 0755);
    if (fd < 0)
        die("open$write_file");

    if (write(fd, buf, buflen) != buflen)
        die("write$write_file");

    close(fd);
}

int read_file(const char *filename, void *buf, size_t buflen)
{
    int fd;
    int retv;

    fd = open(filename, O_RDONLY);
    if (fd < 0)
        die("open$read_file");

    retv = read(fd, buf, buflen);
    if (retv < 0)
        perror("read$read_file");

    close(fd);

    return retv;
}
